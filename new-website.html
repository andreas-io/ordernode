<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PPE Kiosk Auto Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #m2frame {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Hidden swipe input */
        #swipeInput {
            position: absolute;
            top: -200px;
            opacity: 0;
        }
    </style>
</head>

<body>

<!-- Hidden input to capture swipe -->
<input type="password" id="swipeInput" autofocus>

<!-- Magento login page -->
<iframe 
    id="m2frame"
    src="https://m2-prod-chelmsfordsafety-co-uk.cfstack.com/customer/account/login/"
    onload="setupAutoFill()">
</iframe>

<script>
/*
    Step 1: Listen for card swipe
*/
document.getElementById('swipeInput').addEventListener('input', function(e) {
    const v = e.target.value;

    if (v.startsWith('%') && v.endsWith('?')) {
        const cleanUser = v.slice(1, -1);
        window.swipedUser = cleanUser;

        // Clear input so next swipe works
        e.target.value = "";

        // Try autofill immediately if frame is ready
        autoFillIfReady();
    }
});


/*
    Step 2: When iframe loads, prepare to interact with it
*/
function setupAutoFill() {
    // Try to run autofill once iframe is loaded
    autoFillIfReady();
}


/*
    Step 3: Autofill function
*/
function autoFillIfReady() {

    const username = window.swipedUser;
    if (!username) {
        return; // No card swiped yet
    }

    const frame = document.getElementById('m2frame');
    const frameDoc = frame.contentWindow.document;

    let emailField = frameDoc.querySelector('input[name="login[username]"]');
    let pwField = frameDoc.querySelector('input[name="login[password]"]');
    let signInBtn = frameDoc.querySelector('button[name="send"]');

    // If elements not available yet, retry
    if (!emailField || !pwField || !signInBtn) {
        setTimeout(autoFillIfReady, 300);
        return;
    }

    // Fill username
    emailField.value = username;

    // Fill password
    pwField.value = "FEL008!";

    // Click the Sign In button after slight delay
    setTimeout(() => {
        signInBtn.click();
    }, 500);
}
</script>

</body>
</html>
